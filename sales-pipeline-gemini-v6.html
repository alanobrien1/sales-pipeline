<!-- Chosen Palette: Warm Neutral & Indigo Accent -->
<!-- Application Structure Plan: The structure maintains the Header, Kanban Board (for status updates), and Analytics/Charts, and the Lead Detail Modal. Kanban cards are clickable to open this Modal, which centralizes all deep-dive activities: Editing lead data, viewing Automated Score, and tracking all past Activities (presented in a list/timeline format). The Activity Timeline now includes a Due Date field for future tasks, which is marked as overdue (red) if the date is past. NEW: Global Activities Modal added for tracking all tasks across all leads in a Calendar/Timeline toggle view. -->
<!-- Visualization & Content Choices: The core Kanban board now incorporates the Automated Lead Score (calculated via JS) for quick prioritization. Forecast Revenue panel displays Expected Value. The Lead Detail Modal features an Activity Timeline (HTML/CSS list) and the Lead Edit Form (HTML/JS data binding). Chart.js visualizations remain for high-level pipeline distribution. NO SVG, NO Mermaid JS. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Funnel Dashboard V6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .kanban-col {
            min-height: 500px;
            max-height: 80vh;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .kanban-col::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 10px;
            line-height: 1;
            border-radius: 9999px;
            color: white;
            padding: 2px;
        }
        .bg-score-low { background-color: #fca5a5; } /* Red-300 */
        .bg-score-medium { background-color: #fcd34d; } /* Amber-400 */
        .bg-score-high { background-color: #34d399; } /* Green-400 */

        @media (max-width: 640px) {
            .kanban-col { min-height: 300px; max-height: 400px; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-gray-800">

    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <header class="mb-8 flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-extrabold text-indigo-700">Lead Pipeline Control Center V6.0</h1>
                <p class="mt-2 text-lg text-gray-500">
                    Manage, score, and forecast your lead pipeline with detailed activity tracking.
                </p>
            </div>
            <!-- NEW LEAD BUTTON AND NEW ACTIVITY TRACKER BUTTON -->
            <div class="mt-3 flex flex-col space-y-2">
                <button onclick="openNewLeadModal()" class="px-6 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 flex items-center justify-center">
                    <span class="text-2xl mr-2">+</span> Add New Lead
                </button>
                <button onclick="openActivitiesModal('timeline')" class="px-6 py-2 text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 transition focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center">
                    <span class="text-xl mr-2">üìÖ</span> View All Activities
                </button>
            </div>
            <!-- END BUTTONS -->
        </header>

        <!-- Pipeline Forecasting Panel -->
        <section id="forecasting-panel" class="bg-indigo-600 text-white p-4 sm:p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <span class="text-sm font-medium opacity-80">Expected Pipeline Value Forecast</span>
                <p id="forecast-value" class="text-3xl sm:text-4xl font-extrabold mt-1">$0</p>
            </div>
            <div class="mt-3 sm:mt-0 text-right">
                <span class="text-sm font-medium opacity-80">Total Leads in Pipeline</span>
                <p id="total-leads" class="text-3xl sm:text-4xl font-extrabold mt-1">0</p>
            </div>
        </section>

        <section id="kanban-overview" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Interactive Pipeline Board</h2>
            <p class="text-gray-600 mb-6">
                Click any card to view activities and edit details. Use the action buttons to manage lead status or log a note.
            </p>
            <div id="kanban-board" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div id="col-New" class="p-3 bg-gray-100 rounded-lg kanban-col shadow-inner">
                    <h3 class="text-base font-semibold text-gray-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">üë§</span> New Lead (MQL)
                    </h3>
                    <div class="space-y-3" data-status="New"></div>
                </div>
                <div id="col-Working" class="p-3 bg-blue-100 rounded-lg kanban-col shadow-inner">
                    <h3 class="text-base font-semibold text-blue-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">üìû</span> Working (SQL)
                    </h3>
                    <div class="space-y-3" data-status="Working"></div>
                </div>
                <div id="col-Proposal" class="p-3 bg-yellow-100 rounded-lg kanban-col shadow-inner">
                    <h3 class="text-base font-semibold text-yellow-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">üìÑ</span> Proposal Stage
                    </h3>
                    <div class="space-y-3" data-status="Proposal"></div>
                </div>
                <div id="col-Won" class="p-3 bg-green-100 rounded-lg kanban-col shadow-inner">
                    <h3 class="text-base font-semibold text-green-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">‚úÖ</span> Closed Won
                    </h3>
                    <div class="space-y-3" data-status="Won"></div>
                </div>
                <div id="col-Lost" class="p-3 bg-red-100 rounded-lg kanban-col shadow-inner">
                    <h3 class="text-base font-semibold text-red-700 mb-3 flex items-center">
                        <span class="text-lg mr-2">‚ùå</span> Closed Lost
                    </h3>
                    <div class="space-y-3" data-status="Lost"></div>
                </div>
            </div>
        </section>

        <section id="analytics-section" class="grid md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Pipeline Distribution</h2>
                <p class="text-gray-600 mb-4">
                    This bar chart shows the current count of active leads in each stage, offering an immediate snapshot of pipeline health.
                </p>
                <div class="chart-container">
                    <canvas id="pipelineBarChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Overall Outcome Ratio</h2>
                <p class="text-gray-600 mb-4">
                    The doughnut chart illustrates the overall ratio of Won vs. Lost leads, reflecting final conversion effectiveness.
                </p>
                <div class="chart-container">
                    <canvas id="conversionDoughnutChart"></canvas>
                </div>
            </div>
        </section>

        <section id="insights-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Key Report Insights</h2>
            <div class="grid md:grid-cols-3 gap-6 text-sm">
                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="font-semibold text-indigo-700 mb-1 flex items-center"><span class="mr-2 text-xl">üí°</span> Finding 1: Qualification</h3>
                    <p class="text-gray-700">Leads moved from 'New' to 'Working' within 48 hours show a 35% higher close rate. Speed is critical for MQL-to-SQL conversion.</p>
                </div>
                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="font-semibold text-indigo-700 mb-1 flex items-center"><span class="mr-2 text-xl">üìä</span> Finding 2: Proposal Impact</h3>
                    <p class="text-gray-700">The primary factor for 'Closed Lost' is high price sensitivity at the 'Proposal' stage. Need better pre-qualification on budget.</p>
                </div>
                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="font-semibold text-indigo-700 mb-1 flex items-center"><span class="mr-2 text-xl">üöÄ</span> Recommendation</h3>
                    <p class="text-gray-700">Implement an automated follow-up sequence for all 'Closed Lost' leads to transition them into a 90-day 'Nurture' campaign.</p>
                </div>
            </div>
        </section>

    </div>

    <!-- Lead Detail/Edit Modal (Existing) -->
    <div id="leadDetailModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="p-6">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-2xl font-bold text-gray-700" id="modal-lead-name">Lead Detail</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <span class="text-xl font-bold">&times;</span>
                    </button>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Edit Form -->
                    <div>
                        <h4 class="text-xl font-semibold text-indigo-600 mb-3">Edit Lead Information</h4>
                        <form id="editLeadForm" onsubmit="event.preventDefault(); saveLeadDetails();">
                            <input type="hidden" id="edit-lead-id">
                            <div class="space-y-4">
                                <div>
                                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                                    <input type="text" id="edit-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit-person-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
                                    <input type="text" id="edit-person-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit-source" class="block text-sm font-medium text-gray-700">Source</label>
                                    <select id="edit-source" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                        <option value="Webinar">Webinar</option>
                                        <option value="Referral">Referral</option>
                                        <option value="Organic Search">Organic Search</option>
                                        <option value="Paid Ads">Paid Ads</option>
                                    </select>
                                </div>
                                <div>
                                    <!-- Changed min="1" to min="0" to allow zero value -->
                                    <label for="edit-value" class="block text-sm font-medium text-gray-700">Value ($)</label>
                                    <input type="number" id="edit-value" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Automated Score:</span>
                                    <span id="modal-score" class="text-lg font-bold text-indigo-600">--</span>
                                </div>
                                <div>
                                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Activity Tracking Timeline -->
                    <div>
                        <h4 class="text-xl font-semibold text-indigo-600 mb-3">Activity Timeline</h4>
                        <div id="activity-timeline" class="space-y-4 max-h-80 overflow-y-auto p-2">
                            <!-- Activities will be rendered here -->
                        </div>
                        <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Add New Activity</h4>
                        <form id="addActivityForm" onsubmit="event.preventDefault(); addActivity(this);">
                            <div class="space-y-2">
                                <input type="text" name="activityType" placeholder="Type (e.g., Call, Email, Meeting)" class="block w-full border border-gray-300 rounded-md p-2 text-sm" required>
                                <input type="text" name="activityDescription" placeholder="Description of action" class="block w-full border border-gray-300 rounded-md p-2 text-sm" required>
                                <!-- NEW DUE DATE FIELD -->
                                <input type="date" name="activityDueDate" class="block w-full border border-gray-300 rounded-md p-2 text-sm">
                                <!-- END NEW DUE DATE FIELD -->
                                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                                    Add Activity
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- NEW LEAD MODAL -->
    <div id="newLeadModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl w-full max-w-lg shadow-2xl transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="p-6">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-2xl font-bold text-gray-700">Add New Lead</h3>
                    <button onclick="closeNewLeadModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <span class="text-xl font-bold">&times;</span>
                    </button>
                </div>

                <form id="addNewLeadForm" onsubmit="event.preventDefault(); addNewLead(this);">
                    <div class="space-y-4">
                        <div>
                            <label for="new-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" id="new-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required placeholder="e.g., Acme Technologies">
                        </div>
                        <div>
                            <label for="new-person-name" class="block text-sm font-medium text-gray-700">Contact Name</label>
                            <input type="text" id="new-person-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required placeholder="e.g., Jane Doe">
                        </div>
                        <div>
                             <!-- Changed min="1" to min="0" to allow zero value -->
                            <label for="new-value" class="block text-sm font-medium text-gray-700">Value ($)</label>
                            <input type="number" id="new-value" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required placeholder="e.g., 15000">
                        </div>
                        <div>
                            <label for="new-source" class="block text-sm font-medium text-gray-700">Source</label>
                            <select id="new-source" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="Webinar">Webinar</option>
                                <option value="Referral">Referral</option>
                                <option value="Organic Search">Organic Search</option>
                                <option value="Paid Ads">Paid Ads</option>
                            </select>
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Create Lead
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Global Activities Modal (NEW) -->
    <div id="activitiesModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl w-full max-w-4xl shadow-2xl transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="p-6">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h3 class="text-2xl font-bold text-gray-700">Global Activity Calendar & Timeline</h3>
                    <button onclick="closeActivitiesModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <span class="text-xl font-bold">&times;</span>
                    </button>
                </div>
                
                <!-- Toggle View Buttons -->
                <div class="flex space-x-4 mb-4">
                    <button id="timeline-btn" onclick="toggleActivityView('timeline')" class="py-2 px-4 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 transition">
                        Timeline View
                    </button>
                    <button id="calendar-btn" onclick="toggleActivityView('calendar')" class="py-2 px-4 rounded-lg text-sm font-medium bg-gray-200 text-gray-800 hover:bg-gray-300 transition">
                        Calendar View
                    </button>
                </div>

                <!-- Content Area -->
                <div id="activities-content" class="min-h-[400px]">
                    <p class="text-center text-gray-500 mt-10">Loading activities...</p>
                </div>

            </div>
        </div>
    </div>


    <script>
        const INITIAL_LEADS = [
            // Added default dueDate for existing activities
            { id: 1, name: 'Alpha Solutions', personName: 'Jane Doe', status: 'Working', source: 'Webinar', value: 12000, activities: [{date: '2024-10-01', type: 'Call', description: 'Initial contact call. Identified need for service A.', dueDate: '2025-11-05'}, {date: '2024-10-05', type: 'Email', description: 'Sent proposal overview.', dueDate: '2025-11-20'}] },
            { id: 2, name: 'Beta Systems Inc.', personName: 'John Smith', status: 'New', source: 'Referral', value: 8500, activities: [{date: '2024-10-10', type: 'Call', description: 'Referral warm lead. Needs follow-up with demo.', dueDate: '2025-11-10'}] },
            { id: 3, name: 'Gamma Corp', personName: 'Elara Vance', status: 'Proposal', source: 'Organic Search', value: 25000, activities: [{date: '2024-10-15', type: 'Meeting', description: 'Presentation of full proposal and pricing.', dueDate: '2025-11-15'}, {date: '2024-10-20', type: 'Email', description: 'Followed up with case studies.', dueDate: ''}] },
            { id: 4, name: 'Delta Technologies', personName: 'Tom Harris', status: 'Working', source: 'Paid Ads', value: 5000, activities: [{date: '2024-09-25', type: 'Email', description: 'Sent initial discovery questions.', dueDate: '2025-11-01'}] },
            { id: 5, name: 'Epsilon Group', personName: 'Susan Kim', status: 'Won', source: 'Webinar', value: 18000, activities: [{date: '2024-09-01', type: 'Won', description: 'Contract signed. Onboarding started.', dueDate: ''}] },
            { id: 6, name: 'Zeta Innovations', personName: 'David Lee', status: 'Lost', source: 'Referral', value: 9000, activities: [{date: '2024-09-15', type: 'Lost', description: 'Lost to competitor due to budget constraints.', dueDate: ''}] },
            { id: 7, name: 'Eta Ventures', personName: 'Maria Rodriguez', status: 'New', source: 'Organic Search', value: 3000, activities: [] },
            { id: 8, name: 'Theta Holdings', personName: 'Robert Johnson', status: 'Working', source: 'Referral', value: 45000, activities: [{date: '2024-10-28', type: 'Meeting', description: 'Discovery meeting. High potential lead.', dueDate: '2025-12-05'}] },
        ];

        let leads = INITIAL_LEADS.map(lead => ({
            ...lead,
            id: lead.id,
            score: calculateLeadScore(lead.source, lead.value) // Calculate initial score
        }));

        // Track the next available ID for new leads
        let nextId = Math.max(...INITIAL_LEADS.map(l => l.id)) + 1;

        let pipelineBarChart;
        let conversionDoughnutChart;
        let currentEditingLeadId = null;
        
        // Helper function for date comparison
        const isOverdue = (dueDate) => {
            if (!dueDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            return due < today;
        }

        const STATUS_MAP = {
            New: { label: 'Working', next: 'Working', prev: null, color: 'text-gray-700', bg: 'bg-gray-100', prob: 0.10 },
            Working: { label: 'Proposal', next: 'Proposal', prev: 'New', color: 'text-blue-700', bg: 'bg-blue-100', prob: 0.40 },
            Proposal: { label: 'Finalize', next: ['Won', 'Lost'], prev: 'Working', color: 'text-yellow-700', bg: 'bg-yellow-100', prob: 0.75 },
            Won: { label: 'Archived', next: null, prev: 'Proposal', color: 'text-green-700', bg: 'bg-green-100', prob: 1.00 },
            Lost: { label: 'Archived', next: null, prev: 'Proposal', color: 'text-red-700', bg: 'bg-red-100', prob: 0.00 }
        };

        const abbreviateLabel = (label, maxChars = 16) => {
            if (label.length <= maxChars) return label;
            let words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length > maxChars) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine += ' ' + word;
                }
            });
            lines.push(currentLine.trim());
            return lines;
        };

        function getScoreColor(score) {
            if (score > 30) return 'bg-score-high';
            if (score > 15) return 'bg-score-medium';
            return 'bg-score-low';
        }

        function calculateLeadScore(source, value) {
            let score = 0;
            const valueNum = Number(value);

            // Source Scoring
            switch (source) {
                case 'Referral': score += 20; break;
                case 'Organic Search': score += 15; break;
                case 'Webinar': score += 10; break;
                case 'Paid Ads': score += 5; break;
            }

            // Value Scoring (now allows 0 value)
            if (valueNum > 20000) {
                score += 20;
            } else if (valueNum >= 10000) {
                score += 10;
            } else if (valueNum > 0) { // Gives 5 points only if value > 0
                score += 5;
            }

            return score;
        }

        const renderKanban = () => {
            document.querySelectorAll('#kanban-board > div > div').forEach(container => container.innerHTML = '');

            leads.forEach(lead => {
                const colContainer = document.querySelector(`[data-status="${lead.status}"]`);
                if (!colContainer) return;

                const statusConfig = STATUS_MAP[lead.status];
                const card = document.createElement('div');
                card.className = `p-3 rounded-lg card-shadow text-sm ${statusConfig.bg} border-l-4 border-indigo-500 cursor-pointer hover:shadow-lg transition`;
                card.setAttribute('onclick', `openEditModal(${lead.id})`);
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-900">${lead.name}</p>
                        <span class="score-badge ${getScoreColor(lead.score)}">${lead.score}</span>
                    </div>
                    <p class="text-xs text-indigo-600 mt-0.5">${lead.personName}</p>
                    <p class="text-xs text-gray-500 mt-0.5">Value: $${lead.value.toLocaleString()}</p>
                    <div class="mt-3 flex flex-wrap gap-2">
                        
                        ${lead.status === 'Proposal' ? `
                            <button onclick="event.stopPropagation(); moveLead(${lead.id}, 'Won')"
                                class="flex-grow px-2 py-1 text-xs font-medium text-white bg-green-500 rounded-md hover:bg-green-600 transition">
                                Win
                            </button>
                            <button onclick="event.stopPropagation(); moveLead(${lead.id}, 'Lost')"
                                class="flex-grow px-2 py-1 text-xs font-medium text-white bg-red-500 rounded-md hover:bg-red-600 transition">
                                Lose
                            </button>
                        ` : `
                            <!-- Default Status Movement (New/Working) -->
                            ${lead.status !== 'Won' && lead.status !== 'Lost' ? `
                                <button onclick="event.stopPropagation(); moveLead(${lead.id}, '${statusConfig.next}')"
                                    class="flex-grow px-2 py-1 text-xs font-medium text-white bg-indigo-500 rounded-md hover:bg-indigo-600 transition">
                                    Move to ${STATUS_MAP[statusConfig.next]?.label || statusConfig.next}
                                </button>
                            ` : ''}
                        `}
                        
                        <!-- Log Note Button (For all active statuses: New, Working, Proposal) -->
                        ${lead.status !== 'Won' && lead.status !== 'Lost' ? `
                            <button onclick="event.stopPropagation(); openEditModal(${lead.id})"
                                class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                Log Note
                            </button>
                        ` : ''}
                        
                        <!-- Back Button (For Working, Proposal) -->
                        ${lead.status !== 'Won' && lead.status !== 'Lost' && statusConfig.prev ? `
                            <button onclick="event.stopPropagation(); moveLead(${lead.id}, '${statusConfig.prev}')"
                                class="px-2 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                Back
                            </button>
                        ` : ''}
                    </div>
                `;
                colContainer.appendChild(card);
            });
            updateCharts();
            updateForecasting();
        };

        const moveLead = (id, newStatus) => {
            const leadIndex = leads.findIndex(l => l.id === id);
            if (leadIndex !== -1) {
                if (Array.isArray(newStatus)) return;
                const oldStatus = leads[leadIndex].status;
                leads[leadIndex].status = newStatus;
                
                // Add an automated activity for status change
                const today = new Date().toISOString().split('T')[0];
                const activityType = newStatus === 'Won' ? 'Closed Won' : newStatus === 'Lost' ? 'Closed Lost' : 'Status Change';
                leads[leadIndex].activities.push({
                    date: today,
                    type: activityType,
                    description: `Moved from ${oldStatus} to ${newStatus}.`,
                    dueDate: '' // Default empty due date for automated activities
                });

                renderKanban();
            }
        };

        const updateForecasting = () => {
            let expectedValue = 0;
            let totalLeads = leads.length;

            leads.forEach(lead => {
                const probability = STATUS_MAP[lead.status] ? STATUS_MAP[lead.status].prob : 0;
                expectedValue += lead.value * probability;
            });

            document.getElementById('forecast-value').textContent = `$${Math.round(expectedValue).toLocaleString()}`;
            document.getElementById('total-leads').textContent = totalLeads;
        };

        // --- Lead Detail Modal Functions ---

        const openEditModal = (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;

            currentEditingLeadId = id;

            // Populate form fields
            document.getElementById('modal-lead-name').textContent = lead.name;
            document.getElementById('edit-lead-id').value = id;
            document.getElementById('edit-name').value = lead.name;
            document.getElementById('edit-person-name').value = lead.personName; 
            document.getElementById('edit-source').value = lead.source;
            document.getElementById('edit-value').value = lead.value;
            document.getElementById('modal-score').textContent = lead.score;

            renderActivityTimeline(lead.activities);

            const modal = document.getElementById('leadDetailModal');
            modal.classList.remove('invisible', 'opacity-0');
            modal.classList.add('visible', 'opacity-100');
        };

        const closeModal = () => {
            const modal = document.getElementById('leadDetailModal');
            modal.classList.add('invisible', 'opacity-0');
            modal.classList.remove('visible', 'opacity-100');
            currentEditingLeadId = null;
        };

        const saveLeadDetails = () => {
            const id = Number(document.getElementById('edit-lead-id').value);
            const leadIndex = leads.findIndex(l => l.id === id);

            if (leadIndex !== -1) {
                const newName = document.getElementById('edit-name').value;
                const newPersonName = document.getElementById('edit-person-name').value; 
                const newSource = document.getElementById('edit-source').value;
                const newValue = Number(document.getElementById('edit-value').value);

                leads[leadIndex].name = newName;
                leads[leadIndex].personName = newPersonName; 
                leads[leadIndex].source = newSource;
                leads[leadIndex].value = newValue;
                leads[leadIndex].score = calculateLeadScore(newSource, newValue);

                document.getElementById('modal-score').textContent = leads[leadIndex].score;
                document.getElementById('modal-lead-name').textContent = newName;

                renderKanban();
            }
        };

        const renderActivityTimeline = (activities) => {
            const timelineDiv = document.getElementById('activity-timeline');
            timelineDiv.innerHTML = '';

            // Sort by recorded date, newest first
            const sortedActivities = [...activities].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedActivities.length === 0) {
                timelineDiv.innerHTML = '<p class="text-gray-500 italic">No activities recorded for this lead.</p>';
                return;
            }

            sortedActivities.forEach(activity => {
                const element = document.createElement('div');
                element.className = 'relative pl-8 border-l-2 border-indigo-200';
                
                // Determine due date styling
                let dueDateHtml = '';
                if (activity.dueDate) {
                    const dueClassName = isOverdue(activity.dueDate) ? 'text-red-600 font-bold' : 'text-green-600 font-medium';
                    const dueText = isOverdue(activity.dueDate) ? 'OVERDUE' : 'Due Date';
                    dueDateHtml = `<p class="text-xs ${dueClassName} mb-1">${dueText}: ${activity.dueDate}</p>`;
                }

                element.innerHTML = `
                    <div class="absolute w-3 h-3 bg-indigo-500 rounded-full mt-1.5 -left-1.5"></div>
                    <div class="text-xs text-indigo-600 font-medium">Recorded: ${activity.date}</div>
                    <div class="mt-0.5 text-sm font-semibold text-gray-800">${activity.type}</div>
                    <p class="text-xs text-gray-600 mb-1">${activity.description}</p>
                    ${dueDateHtml}
                `;
                timelineDiv.appendChild(element);
            });
        };

        const addActivity = (form) => {
            const type = form.activityType.value;
            const description = form.activityDescription.value;
            const dueDate = form.activityDueDate.value; // Capture new Due Date
            const date = new Date().toISOString().split('T')[0];

            const leadIndex = leads.findIndex(l => l.id === currentEditingLeadId);
            if (leadIndex !== -1) {
                const newActivity = { date, type, description, dueDate }; // Save Due Date
                leads[leadIndex].activities.push(newActivity);
                
                renderActivityTimeline(leads[leadIndex].activities);
                renderKanban(); 
                form.reset();
            }
        };


        // --- NEW LEAD FUNCTIONS ---

        const openNewLeadModal = () => {
            document.getElementById('addNewLeadForm').reset();
            const modal = document.getElementById('newLeadModal');
            modal.classList.remove('invisible', 'opacity-0');
            modal.classList.add('visible', 'opacity-100');
        };

        const closeNewLeadModal = () => {
            const modal = document.getElementById('newLeadModal');
            modal.classList.add('invisible', 'opacity-0');
            modal.classList.remove('visible', 'opacity-100');
        };

        const addNewLead = (form) => {
            const newName = form.querySelector('#new-name').value;
            const newPersonName = form.querySelector('#new-person-name').value;
            const newSource = form.querySelector('#new-source').value;
            const newValue = Number(form.querySelector('#new-value').value);
            
            // Validation updated to only check for required strings, value can be 0.
            if (!newName || !newPersonName) {
                console.error("Invalid lead data: Company Name and Contact Name are required.");
                return;
            }

            const newLead = {
                id: nextId++,
                name: newName,
                personName: newPersonName,
                status: 'New', // New leads always start in 'New'
                source: newSource,
                value: newValue,
                activities: [{
                    date: new Date().toISOString().split('T')[0],
                    type: 'Created',
                    description: `Lead created from ${newSource} source.`,
                    dueDate: ''
                }],
                score: calculateLeadScore(newSource, newValue)
            };

            leads.push(newLead);
            renderKanban();
            closeNewLeadModal();
        };

        // --- NEW GLOBAL ACTIVITIES FUNCTIONS ---

        const getAllActivities = () => {
            let allActivities = [];
            leads.forEach(lead => {
                lead.activities.forEach(activity => {
                    // Only include activities that have a due date for the calendar/timeline view context
                    if (activity.dueDate) {
                        allActivities.push({
                            leadId: lead.id,
                            leadName: lead.name,
                            status: lead.status,
                            dueDate: activity.dueDate,
                            type: activity.type,
                            description: activity.description
                        });
                    }
                });
            });
            // Sort by Due Date, ascending (for timeline)
            return allActivities.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        };

        const openActivitiesModal = (initialView = 'timeline') => {
            const modal = document.getElementById('activitiesModal');
            modal.classList.remove('invisible', 'opacity-0');
            modal.classList.add('visible', 'opacity-100');
            toggleActivityView(initialView);
            // Hide popups when modal opens
            document.querySelectorAll('#activities-content .absolute.z-20').forEach(p => p.classList.add('hidden'));
        };

        const closeActivitiesModal = () => {
            const modal = document.getElementById('activitiesModal');
            modal.classList.add('invisible', 'opacity-0');
            modal.classList.remove('visible', 'opacity-100');
        };

        const toggleActivityView = (viewType) => {
            const activities = getAllActivities();

            const timelineBtn = document.getElementById('timeline-btn');
            const calendarBtn = document.getElementById('calendar-btn');

            if (viewType === 'timeline') {
                renderActivityTimelineView(activities);
                timelineBtn.classList.remove('bg-gray-200', 'text-gray-800');
                timelineBtn.classList.add('bg-indigo-600', 'text-white');
                calendarBtn.classList.remove('bg-indigo-600', 'text-white');
                calendarBtn.classList.add('bg-gray-200', 'text-gray-800');
            } else if (viewType === 'calendar') {
                renderActivityCalendarView(activities);
                calendarBtn.classList.remove('bg-gray-200', 'text-gray-800');
                calendarBtn.classList.add('bg-indigo-600', 'text-white');
                timelineBtn.classList.remove('bg-indigo-600', 'text-white');
                timelineBtn.classList.add('bg-gray-200', 'text-gray-800');
            }
        };

        const renderActivityTimelineView = (activities) => {
            const contentDiv = document.getElementById('activities-content');
            contentDiv.innerHTML = ''; // Clear content

            if (activities.length === 0) {
                contentDiv.innerHTML = '<p class="text-gray-500 italic p-4">No future activities with due dates recorded across all leads.</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            activities.forEach(activity => {
                const isPast = activity.dueDate < today;
                const statusColor = activity.status === 'Won' ? 'text-green-700' : 
                                    activity.status === 'Lost' ? 'text-red-700' : 
                                    'text-indigo-700';
                const overdueClass = isPast ? 'border-red-400 bg-red-50' : 'border-indigo-400 bg-indigo-50';

                const element = document.createElement('div');
                element.className = `p-3 rounded-lg border-l-4 shadow-sm mb-3 ${overdueClass}`;
                element.innerHTML = `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-bold ${isPast ? 'text-red-700' : statusColor}">
                            ${isPast ? 'üî¥ OVERDUE' : '‚úÖ Due Date'}: ${activity.dueDate}
                        </span>
                        <span class="text-xs text-gray-500">Lead ID: ${activity.leadId}</span>
                    </div>
                    <div class="mt-1 flex justify-between items-baseline">
                        <p class="text-lg font-semibold text-gray-800">${activity.leadName} - ${activity.type}</p>
                        <span class="text-xs font-medium ${statusColor}">Status: ${activity.status}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${activity.description}</p>
                `;
                contentDiv.appendChild(element);
            });
        };

        const renderActivityCalendarView = (activities) => {
            const contentDiv = document.getElementById('activities-content');
            
            // Use the current month for the simple calendar view
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed
            
            // Filter activities to only include the current month
            const currentMonthActivities = activities.filter(a => {
                const d = new Date(a.dueDate);
                return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
            });

            // Group activities by day
            const activitiesByDay = currentMonthActivities.reduce((acc, activity) => {
                const d = new Date(activity.dueDate);
                const day = d.getDate();
                // Ensure date is valid before pushing
                if (!isNaN(day)) {
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(activity);
                }
                return acc;
            }, {});

            // Calendar generation logic
            const monthName = today.toLocaleString('default', { month: 'long' });
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon

            let calendarHtml = `
                <div class="text-center mb-4">
                    <h4 class="text-2xl font-bold text-indigo-700">${monthName} ${currentYear}</h4>
                    <p class="text-gray-500 text-sm">Click any highlighted day to view scheduled activities.</p>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-medium text-gray-600 border-b pb-2 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;

            // Add empty cells for the start of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarHtml += '<div class="h-16"></div>';
            }

            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const hasActivity = activitiesByDay[day] && activitiesByDay[day].length > 0;
                const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
                
                let cellClass = 'p-2 rounded-lg h-20 relative flex flex-col justify-start items-start text-sm transition';
                let dayNumberClass = 'font-bold text-gray-800';
                let activityIndicator = '';
                let popupContent = '';
                
                if (hasActivity) {
                    cellClass += ' bg-blue-100 hover:bg-blue-200 border border-blue-400 cursor-pointer group';
                    activityIndicator = `<span class="mt-1 text-xs text-blue-800 font-semibold">${activitiesByDay[day].length} Task(s)</span>`;
                    
                    const activityList = activitiesByDay[day].map(a => `
                        <li class="text-xs truncate text-gray-700 font-medium">
                            <span class="${isOverdue(a.dueDate) ? 'text-red-600' : 'text-green-600'}">‚Ä¢</span> ${a.leadName} (${a.type})
                        </li>
                    `).join('');

                    popupContent = `
                        <div class="absolute hidden top-full left-0 w-64 md:w-80 mt-1 p-3 bg-white border border-gray-300 rounded-lg shadow-xl z-20 text-left overflow-y-auto max-h-60">
                            <p class="font-bold text-indigo-700 mb-1">Tasks for ${monthName} ${day}</p>
                            <ul class="space-y-1">${activityList}</ul>
                        </div>
                    `;
                } else {
                    cellClass += ' bg-gray-50 border border-gray-200';
                }

                if (isToday) {
                    cellClass = cellClass.replace('bg-gray-50', 'bg-green-100 ring-2 ring-green-500');
                    dayNumberClass = 'font-bold text-green-800';
                }
                

                calendarHtml += `
                    <div class="${cellClass}" data-day="${day}">
                        <span class="${dayNumberClass}">${day}</span>
                        ${activityIndicator}
                        ${popupContent}
                    </div>
                `;
            }

            calendarHtml += `</div>`;
            contentDiv.innerHTML = calendarHtml;

            // Attach click listeners to show the details popup
            contentDiv.querySelectorAll('[data-day]').forEach(cell => {
                if (cell.classList.contains('cursor-pointer')) {
                    cell.onclick = (e) => {
                        e.stopPropagation();
                        // Hide all other popups
                        document.querySelectorAll('#activities-content .absolute.z-20').forEach(p => p.classList.add('hidden'));

                        const detailsDiv = cell.querySelector('.absolute.z-20');
                        if (detailsDiv) {
                            detailsDiv.classList.remove('hidden');
                        }
                    };
                }
            });

            // Global click listener on the modal to hide popups
            document.getElementById('activitiesModal').onclick = (e) => {
                if (!e.target.closest('[data-day]')) {
                    document.querySelectorAll('#activities-content .absolute.z-20').forEach(p => p.classList.add('hidden'));
                }
            };
        };

        // --- Charting Functions (Updated) ---

        const updateCharts = () => {
            const statusCounts = leads.reduce((acc, lead) => {
                acc[lead.status] = (acc[lead.status] || 0) + 1;
                return acc;
            }, {});

            const barLabels = ['New', 'Working', 'Proposal', 'Won', 'Lost'];
            const barData = barLabels.map(status => statusCounts[status] || 0);

            const wonCount = statusCounts.Won || 0;
            const lostCount = statusCounts.Lost || 0;
            const totalOutcomes = wonCount + lostCount;

            // Chart.js Bar Chart: Pipeline Distribution
            const barCtx = document.getElementById('pipelineBarChart').getContext('2d');
            if (pipelineBarChart) pipelineBarChart.destroy();
            pipelineBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels.map(l => abbreviateLabel(l, 10)),
                    datasets: [{
                        label: 'Leads Count',
                        data: barData,
                        backgroundColor: ['#e5e7eb', '#bfdbfe', '#fef3c7', '#dcfce7', '#fee2e2'],
                        borderColor: ['#9ca3af', '#60a5fa', '#fcd34d', '#4ade80', '#f87171'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => items[0].label.replace(/,/g, ' '),
                                label: (item) => `Leads: ${item.formattedValue}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, suggestedMax: Math.max(...barData) + 2 },
                        x: { ticks: { callback: (val, index) => barLabels[index] } }
                    }
                }
            });

            // Chart.js Doughnut Chart: Overall Outcome Ratio
            const doughnutCtx = document.getElementById('conversionDoughnutChart').getContext('2d');
            if (conversionDoughnutChart) conversionDoughnutChart.destroy();
            conversionDoughnutChart = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Closed Won', 'Closed Lost'],
                    datasets: [{
                        data: [wonCount, lostCount],
                        backgroundColor: ['#10b981', '#ef4444'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const total = totalOutcomes;
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.onload = () => {
            renderKanban();
        };
    </script>
</body>
</html>
