import React, { useState, useEffect, useRef } from 'react';
import { Plus, Calendar, CheckSquare, Mail, Users, Phone, DollarSign, Search, Bell, X, TrendingUp, BarChart3, Download, Upload, Settings, Trash2, Edit2, Copy, Moon, Sun, Target, Award, Clock } from 'lucide-react';

const DEFAULT_STAGES = [
  { id: 'lead', name: 'Lead', color: 'bg-gray-500', probability: 10 },
  { id: 'qualified', name: 'Qualified', color: 'bg-blue-500', probability: 25 },
  { id: 'proposal', name: 'Proposal', color: 'bg-purple-500', probability: 50 },
  { id: 'negotiation', name: 'Negotiation', color: 'bg-orange-500', probability: 75 },
  { id: 'closed-won', name: 'Closed Won', color: 'bg-green-500', probability: 100 },
  { id: 'closed-lost', name: 'Closed Lost', color: 'bg-red-500', probability: 0 }
];

const ACTIVITY_TYPES = [
  { id: 'call', name: 'Call', icon: Phone },
  { id: 'email', name: 'Email', icon: Mail },
  { id: 'meeting', name: 'Meeting', icon: Users },
  { id: 'todo', name: 'To Do', icon: CheckSquare }
];

const LEAD_SOURCES = ['Website', 'Referral', 'Cold Call', 'LinkedIn', 'Email Campaign', 'Trade Show', 'Other'];
const INDUSTRIES = ['Technology', 'Healthcare', 'Finance', 'Manufacturing', 'Retail', 'Consulting', 'Other'];

export default function SalesPipelineApp() {
  const [view, setView] = useState('pipeline');
  const [leads, setLeads] = useState([]);
  const [stages, setStages] = useState(DEFAULT_STAGES);
  const [showAddLead, setShowAddLead] = useState(false);
  const [showAddActivity, setShowAddActivity] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [selectedLead, setSelectedLead] = useState(null);
  const [selectedLeads, setSelectedLeads] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterBy, setFilterBy] = useState('all');
  const [sortBy, setSortBy] = useState('date');
  const [darkMode, setDarkMode] = useState(false);
  const [showBulkActions, setShowBulkActions] = useState(false);
  const [workflows, setWorkflows] = useState([]);
  const fileInputRef = useRef(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const result = await window.storage.get('sales-complete-data');
      if (result) {
        const data = JSON.parse(result.value);
        setLeads(data.leads || []);
        setStages(data.stages || DEFAULT_STAGES);
        setWorkflows(data.workflows || []);
        setDarkMode(data.darkMode || false);
      }
    } catch (error) {
      console.log('No existing data found');
    }
  };

  const saveData = async (updatedLeads, updatedStages = stages, updatedWorkflows = workflows) => {
    try {
      await window.storage.set('sales-complete-data', JSON.stringify({ 
        leads: updatedLeads,
        stages: updatedStages,
        workflows: updatedWorkflows,
        darkMode
      }));
    } catch (error) {
      console.error('Error saving data:', error);
    }
  };

  const calculateLeadScore = (lead) => {
    let score = 0;
    if (lead.value > 10000) score += 30;
    else if (lead.value > 5000) score += 20;
    else if (lead.value > 1000) score += 10;
    
    if (lead.email) score += 10;
    if (lead.phone) score += 10;
    if (lead.company) score += 10;
    if (lead.industry) score += 10;
    if (lead.leadSource === 'Referral') score += 20;
    
    return Math.min(score, 100);
  };

  const addLead = (leadData) => {
    const newLead = {
      id: Date.now().toString(),
      ...leadData,
      stage: 'lead',
      createdAt: new Date().toISOString(),
      activities: [],
      history: [{
        date: new Date().toISOString(),
        action: 'Created',
        user: 'Current User'
      }],
      score: calculateLeadScore(leadData)
    };
    const updatedLeads = [...leads, newLead];
    setLeads(updatedLeads);
    saveData(updatedLeads);
    setShowAddLead(false);
  };

  const updateLead = (leadId, updates) => {
    const updatedLeads = leads.map(lead => {
      if (lead.id === leadId) {
        const updated = { ...lead, ...updates };
        if (updates.stage && updates.stage !== lead.stage) {
          updated.history = [...(lead.history || []), {
            date: new Date().toISOString(),
            action: `Stage changed to ${stages.find(s => s.id === updates.stage)?.name}`,
            user: 'Current User'
          }];
        }
        updated.score = calculateLeadScore(updated);
        return updated;
      }
      return lead;
    });
    setLeads(updatedLeads);
    saveData(updatedLeads);
  };

  const updateLeadStage = (leadId, newStage) => {
    updateLead(leadId, { stage: newStage });
  };

  const deleteLead = (leadId) => {
    if (confirm('Are you sure you want to delete this lead?')) {
      const updatedLeads = leads.filter(lead => lead.id !== leadId);
      setLeads(updatedLeads);
      saveData(updatedLeads);
    }
  };

  const duplicateLead = (leadId) => {
    const lead = leads.find(l => l.id === leadId);
    if (lead) {
      const newLead = {
        ...lead,
        id: Date.now().toString(),
        name: lead.name + ' (Copy)',
        createdAt: new Date().toISOString(),
        activities: [],
        history: [{
          date: new Date().toISOString(),
          action: 'Duplicated from ' + lead.name,
          user: 'Current User'
        }]
      };
      const updatedLeads = [...leads, newLead];
      setLeads(updatedLeads);
      saveData(updatedLeads);
    }
  };

  const addActivity = (activityData) => {
    const updatedLeads = leads.map(lead =>
      lead.id === selectedLead.id
        ? {
            ...lead,
            activities: [...(lead.activities || []), {
              id: Date.now().toString(),
              ...activityData,
              createdAt: new Date().toISOString(),
              completed: false
            }],
            history: [...(lead.history || []), {
              date: new Date().toISOString(),
              action: `Activity added: ${activityData.description}`,
              user: 'Current User'
            }]
          }
        : lead
    );
    setLeads(updatedLeads);
    saveData(updatedLeads);
    setShowAddActivity(false);
    setSelectedLead(null);
  };

  const completeActivity = (leadId, activityId) => {
    const updatedLeads = leads.map(lead =>
      lead.id === leadId
        ? {
            ...lead,
            activities: lead.activities.map(activity =>
              activity.id === activityId
                ? { ...activity, completed: !activity.completed }
                : activity
            )
          }
        : lead
    );
    setLeads(updatedLeads);
    saveData(updatedLeads);
  };

  const bulkUpdateStage = (newStage) => {
    const updatedLeads = leads.map(lead =>
      selectedLeads.includes(lead.id)
        ? { ...lead, stage: newStage }
        : lead
    );
    setLeads(updatedLeads);
    saveData(updatedLeads);
    setSelectedLeads([]);
    setShowBulkActions(false);
  };

  const bulkDelete = () => {
    if (confirm(`Delete ${selectedLeads.length} leads?`)) {
      const updatedLeads = leads.filter(lead => !selectedLeads.includes(lead.id));
      setLeads(updatedLeads);
      saveData(updatedLeads);
      setSelectedLeads([]);
      setShowBulkActions(false);
    }
  };

  const exportCSV = () => {
    const headers = ['Name', 'Company', 'Email', 'Phone', 'Stage', 'Value', 'Lead Source', 'Industry', 'Created'];
    const rows = leads.map(lead => [
      lead.name,
      lead.company || '',
      lead.email || '',
      lead.phone || '',
      stages.find(s => s.id === lead.stage)?.name || '',
      lead.value || 0,
      lead.leadSource || '',
      lead.industry || '',
      new Date(lead.createdAt).toLocaleDateString()
    ]);
    
    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `leads-export-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  const importCSV = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const lines = e.target.result.split('\n');
          const importedLeads = [];
          
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
              const values = lines[i].split(',').map(v => v.trim());
              const lead = {
                id: Date.now().toString() + i,
                name: values[0] || '',
                company: values[1] || '',
                email: values[2] || '',
                phone: values[3] || '',
                stage: 'lead',
                value: parseFloat(values[5]) || 0,
                leadSource: values[6] || '',
                industry: values[7] || '',
                createdAt: new Date().toISOString(),
                activities: [],
                history: [{
                  date: new Date().toISOString(),
                  action: 'Imported from CSV',
                  user: 'Current User'
                }]
              };
              importedLeads.push(lead);
            }
          }
          
          const updatedLeads = [...leads, ...importedLeads];
          setLeads(updatedLeads);
          saveData(updatedLeads);
          alert(`Imported ${importedLeads.length} leads successfully!`);
        } catch (error) {
          alert('Error importing CSV. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
  };

  const getAllActivities = () => {
    const activities = [];
    leads.forEach(lead => {
      (lead.activities || []).forEach(activity => {
        activities.push({
          ...activity,
          leadName: lead.name,
          leadId: lead.id
        });
      });
    });
    return activities.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  };

  const getUpcomingActivities = () => {
    const now = new Date();
    const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
    return getAllActivities().filter(activity => {
      const dueDate = new Date(activity.dueDate);
      return !activity.completed && dueDate <= threeDaysFromNow;
    });
  };

  const getAnalytics = () => {
    const totalValue = leads.reduce((sum, lead) => sum + (lead.value || 0), 0);
    const weightedValue = leads.reduce((sum, lead) => {
      const stage = stages.find(s => s.id === lead.stage);
      return sum + (lead.value || 0) * ((stage?.probability || 0) / 100);
    }, 0);
    
    const wonDeals = leads.filter(l => l.stage === 'closed-won');
    const lostDeals = leads.filter(l => l.stage === 'closed-lost');
    const winRate = wonDeals.length + lostDeals.length > 0
      ? (wonDeals.length / (wonDeals.length + lostDeals.length) * 100).toFixed(1)
      : 0;
    
    const avgDealSize = leads.length > 0 ? totalValue / leads.length : 0;
    
    const conversionRates = {};
    stages.forEach((stage, idx) => {
      if (idx < stages.length - 2) {
        const current = leads.filter(l => l.stage === stage.id).length;
        const next = leads.filter(l => l.stage === stages[idx + 1].id).length;
        conversionRates[stage.id] = current > 0 ? (next / current * 100).toFixed(1) : 0;
      }
    });
    
    return {
      totalValue,
      weightedValue,
      winRate,
      avgDealSize,
      conversionRates,
      totalLeads: leads.length,
      wonDeals: wonDeals.length,
      lostDeals: lostDeals.length
    };
  };

  const filteredLeads = leads.filter(lead => {
    const matchesSearch = lead.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      lead.company?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      lead.email?.toLowerCase().includes(searchTerm.toLowerCase());
    
    if (filterBy === 'all') return matchesSearch;
    if (filterBy === 'high-value') return matchesSearch && (lead.value || 0) > 5000;
    if (filterBy === 'hot') return matchesSearch && lead.score > 70;
    if (filterBy === 'overdue') {
      const hasOverdue = lead.activities?.some(a => 
        !a.completed && new Date(a.dueDate) < new Date()
      );
      return matchesSearch && hasOverdue;
    }
    return matchesSearch && lead.stage === filterBy;
  }).sort((a, b) => {
    if (sortBy === 'date') return new Date(b.createdAt) - new Date(a.createdAt);
    if (sortBy === 'value') return (b.value || 0) - (a.value || 0);
    if (sortBy === 'score') return (b.score || 0) - (a.score || 0);
    if (sortBy === 'name') return a.name.localeCompare(b.name);
    return 0;
  });

  const analytics = getAnalytics();
  const bgClass = darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-slate-50 to-slate-100';
  const cardBg = darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = darkMode ? 'text-gray-100' : 'text-slate-900';
  const textSecondary = darkMode ? 'text-gray-400' : 'text-slate-600';

  return (
    <div className={`min-h-screen ${bgClass}`}>
      <header className={`${cardBg} shadow-sm border-b ${darkMode ? 'border-gray-700' : 'border-slate-200'}`}>
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between mb-3">
            <div>
              <h1 className={`text-2xl font-bold ${textClass}`}>Sales Pipeline</h1>
              <p className={`text-sm ${textSecondary} mt-1`}>Track and manage your sales opportunities</p>
              <div className="flex items-center gap-4 mt-2">
                <div className="flex items-center gap-2">
                  <DollarSign className="w-4 h-4 text-green-600" />
                  <span className={`text-sm font-semibold ${textClass}`}>
                    Total: ${analytics.totalValue.toLocaleString()}
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <Target className="w-4 h-4 text-blue-600" />
                  <span className={`text-sm font-semibold ${textClass}`}>
                    Forecast: ${Math.round(analytics.weightedValue).toLocaleString()}
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <Award className="w-4 h-4 text-purple-600" />
                  <span className={`text-sm font-semibold ${textClass}`}>
                    Win Rate: {analytics.winRate}%
                  </span>
                </div>
              </div>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setDarkMode(!darkMode)}
                className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-slate-100 text-slate-700'} hover:opacity-80`}
              >
                {darkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
              </button>
              <button
                onClick={() => setView('pipeline')}
                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                  view === 'pipeline'
                    ? 'bg-blue-600 text-white'
                    : darkMode ? 'bg-gray-700 text-gray-200' : 'bg-slate-100 text-slate-700'
                }`}
              >
                Pipeline
              </button>
              <button
                onClick={() => setView('activities')}
                className={`px-4 py-2 rounded-lg font-medium transition-colors relative ${
                  view === 'activities'
                    ? 'bg-blue-600 text-white'
                    : darkMode ? 'bg-gray-700 text-gray-200' : 'bg-slate-100 text-slate-700'
                }`}
              >
                Activities
                {getUpcomingActivities().length > 0 && (
                  <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                    {getUpcomingActivities().length}
                  </span>
                )}
              </button>
              <button
                onClick={() => setView('analytics')}
                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                  view === 'analytics'
                    ? 'bg-blue-600 text-white'
                    : darkMode ? 'bg-gray-700 text-gray-200' : 'bg-slate-100 text-slate-700'
                }`}
              >
                <BarChart3 className="w-5 h-5" />
              </button>
              <button
                onClick={() => setShowSettings(true)}
                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                  darkMode ? 'bg-gray-700 text-gray-200' : 'bg-slate-100 text-slate-700'
                }`}
              >
                <Settings className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex gap-3 mb-6 flex-wrap">
          <div className="flex-1 min-w-64 relative">
            <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${textSecondary} w-5 h-5`} />
            <input
              type="text"
              placeholder="Search leads..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className={`w-full pl-10 pr-4 py-2 border ${darkMode ? 'bg-gray-800 border-gray-700 text-gray-100' : 'border-slate-300'} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
            />
          </div>
          <select
            value={filterBy}
            onChange={(e) => setFilterBy(e.target.value)}
            className={`px-4 py-2 border ${darkMode ? 'bg-gray-800 border-gray-700 text-gray-100' : 'border-slate-300'} rounded-lg focus:ring-2 focus:ring-blue-500`}
          >
            <option value="all">All Leads</option>
            <option value="high-value">High Value</option>
            <option value="hot">Hot Leads</option>
            <option value="overdue">Overdue</option>
            {stages.map(stage => (
              <option key={stage.id} value={stage.id}>{stage.name}</option>
            ))}
          </select>
          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value)}
            className={`px-4 py-2 border ${darkMode ? 'bg-gray-800 border-gray-700 text-gray-100' : 'border-slate-300'} rounded-lg focus:ring-2 focus:ring-blue-500`}
          >
            <option value="date">Sort by Date</option>
            <option value="value">Sort by Value</option>
            <option value="score">Sort by Score</option>
            <option value="name">Sort by Name</option>
          </select>
          {selectedLeads.length > 0 && (
            <button
              onClick={() => setShowBulkActions(!showBulkActions)}
              className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
            >
              Bulk ({selectedLeads.length})
            </button>
          )}
          <button
            onClick={() => setShowAddLead(true)}
            className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium"
          >
            <Plus className="w-5 h-5" />
            Add Lead
          </button>
        </div>

        {showBulkActions && (
          <div className={`${cardBg} rounded-lg shadow-sm border ${darkMode ? 'border-gray-700' : 'border-slate-200'} p-4 mb-6`}>
            <h3 className={`font-semibold ${textClass} mb-3`}>Bulk Actions</h3>
            <div className="flex gap-2 flex-wrap">
              <select
                onChange={(e) => e.target.value && bulkUpdateStage(e.target.value)}
                className={`px-4 py-2 border ${darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'border-slate-300'} rounded-lg`}
              >
                <option value="">Move to Stage...</option>
                {stages.map(stage => (
                  <option key={stage.id} value={stage.id}>{stage.name}</option>
                ))}
              </select>
              <button
                onClick={bulkDelete}
                className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2"
              >
                <Trash2 className="w-4 h-4" />
                Delete
              </button>
              <button
                onClick={() => {
                  setSelectedLeads([]);
                  setShowBulkActions(false);
                }}
                className={`px-4 py-2 border ${darkMode ? 'border-gray-600 text-gray-300' : 'border-slate-300 text-slate-700'} rounded-lg hover:bg-opacity-50`}
              >
                Cancel
              </button>
            </div>
          </div>
        )}

        {view === 'pipeline' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
            {stages.map(stage => {
              const stageLeads = filteredLeads.filter(lead => lead.stage === stage.id);
              const totalValue = stageLeads.reduce((sum, lead) => sum + (lead.value || 0), 0);
              
              return (
                <div key={stage.id} className={`${cardBg} rounded-lg shadow-sm border ${darkMode ? 'border-gray-700' : 'border-slate-200'}`}>
                  <div className={`${stage.color} text-white p-3 rounded-t-lg`}>
                    <div className="flex items-center justify-between">
                      <h3 className="font-semibold text-sm">{stage.name}</h3>
                      <span className="bg-white bg-opacity-30 px-2 py-0.5 rounded text-xs">
                        {stageLeads.length}
                      </span>
                    </div>
                    {totalValue > 0 && (
                      <p className="text-xs mt-1 opacity-90">
                        ${totalValue.toLocaleString()}
                      </p>
                    )}
                  </div>
                  <div className="p-2 space-y-2 max-h-96 overflow-y-auto">
                    {stageLeads.map(lead => (
                      <LeadCard
                        key={lead.id}
                        lead={lead}
                        stages={stages}
                        darkMode={darkMode}
                        selectedLeads={selectedLeads}
                        onSelect={(id) => {
                          if (selectedLeads.includes(id)) {
                            setSelectedLeads(selectedLeads.filter(i => i !== id));
                          } else {
                            setSelectedLeads([...selectedLeads, id]);
                          }
                        }}
                        onStageChange={updateLeadStage}
                        onAddActivity={() => {
                          setSelectedLead(lead);
                          setShowAddActivity(true);
                        }}
                        onActivityComplete={completeActivity}
                        onDelete={deleteLead}
                        onDuplicate={duplicateLead}
                      />
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        )}

        {view === 'activities' && (
          <div className={`${cardBg} rounded-lg shadow-sm border ${darkMode ? 'border-gray-700' : 'border-slate-200'}`}>
            <div className={`p-4 border-b ${darkMode ? 'border-gray-700' : 'border-slate-200'}`}>
              <h2 className={`text-xl font-semibold ${textClass}`}>All Activities</h2>
            </div>
            <div className={`divide-y ${darkMode ? 'divide-gray-700' : 'divide-slate-200'}`}>
              {getAllActivities().length === 0 ? (
                <div className={`p-8 text-center ${textSecondary}`}>
                  <Calendar className="w-12 h-12 mx-auto mb-3 opacity-50" />
                  <p>No activities yet. Add activities to your leads to see them here.</p>
                </div>
              ) : (
                getAllActivities().map(activity => (
                  <ActivityRow
                    key={activity.id}
                    activity={activity}
                    darkMode={darkMode}
                    onComplete={() => completeActivity(activity.leadId, activity.id)}
                  />
                ))
              )}
            </div>
          </div>
        )}

        {view === 'analytics' && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <AnalyticsCard
                title="Total Pipeline"
                value={`$${analytics.totalValue.toLocaleString()}`}
                icon={DollarSign}
                color="text-green-600"
                darkMode={darkMode}
              />
              <AnalyticsCard
                title="Weighted Forecast"
                value={`$${Math.round(analytics.weightedValue).toLocaleString()}`}
                icon={Target}
                color="text-blue-600"
                darkMode={darkMode}
              />
              <AnalyticsCard
                title="Win Rate"
                value={`${analytics.winRate}%`}
                icon={Award}
                color="text-purple-600"
                darkMode={darkMode}
              />
              <AnalyticsCard
                title="Avg Deal Size"
                value={`$${Math.round(analytics.avgDealSize).toLocaleString()}`}
                icon={TrendingUp}
                color="text-orange-600"
                darkMode={darkMode}
              />
            </div>

            <div className={`${cardBg} rounded-lg shadow-sm border ${darkMode ? 'border-gray-700' : 'border-slate-200'} p-6`}>
              <h3 className={`text-lg font-semibold ${textClass} mb-4`}>Conversion Rates by Stage</h3>
              <div className="space-y-3">
                {Object.entries(analytics.conversionRates).map(([stageId, rate]) => {
                  const stage = stages.find(s => s.id === stageId);
                  return (
                    <div key={stageId}>
                      <div className="flex justify-between mb-1">
                        <span className={`text-sm ${textClass}`}>{stage?.name}</span>
                        <span className={`text-sm font-semibold ${textClass}`}>{rate}%</span>
                      </div>
                      <div className={`w-full ${darkMode ? 'bg-gray-700' : 'bg-slate-200'} rounded-full h-2`}>
                        <div 
                          className={`${stage?.color} h-2 rounded-full`}
                          style={{ width: `${rate}%` }}
                        />
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}
      </div>

      {showAddLead && (
        <AddLeadModal
          onClose={() => setShowAddLead(false)}
          onAdd={addLead}
          darkMode={darkMode}
        />
      )}

      {showAddActivity && selectedLead && (
        <AddActivityModal
          lead={selectedLead}
          onClose={() => {
            setShowAddActivity(false);
            setSelectedLead(null);
          }}
          onAdd={addActivity}
          darkMode={darkMode}
        />
      )}

      {showSettings && (
        <SettingsModal
          onClose={() => setShowSettings(false)}
          onExportCSV={exportCSV}
          onImportCSV={importCSV}
          fileInputRef={fileInputRef}
          darkMode={darkMode}
          leads={leads}
        />
      )}
    </div>
  );
}

function LeadCard({ lead, stages, darkMode, selectedLeads, onSelect, onStageChange, onAddActivity, onActivityComplete, onDelete, onDuplicate }) {
  const [showDetails, setShowDetails] = useState(false);
  const upcomingActivities = (lead.activities || []).filter(a => !a.completed && new Date(a.dueDate) >= new Date());
  const isSelected = selectedLeads.includes(lead.id);

  return (
    <div className={`rounded-lg p-3 transition-all border ${
      isSelected 
        ? 'bg-blue-50 border-blue-400 shadow-md' 
        : darkMode 
          ? 'bg-gray-700 border-gray-600 hover:shadow-md' 
          : 'bg-slate-50 border-slate-200 hover:shadow-md'
    }`}>
      <div className="flex items-start gap-2">
        <input
          type="checkbox"
          checked={isSelected}
          onChange={() => onSelect(lead.id)}
          className="mt-1 rounded"
        />
        <div className="flex-1 cursor-pointer" onClick={() => setShowDetails(!showDetails)}>
          <div className="flex items-start justify-between mb-2">
            <div className="flex-1">
              <h4 className={`font-semibold text-sm ${darkMode ? 'text-gray-100' : 'text-slate-900'}`}>
                {lead.name}
              </h4>
              {lead.company && (
                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-slate-600'}`}>{lead.company}</p>
              )}
            </div>
            <div className="flex items-center gap-2">
              {lead.score > 70 && (
                <span className="text-xs bg-red-500 text-white px-2 py-0.5 rounded">HOT</span>
              )}
              {lead.value && (
                <span className="text-xs font-semibold text-green-600">
                  ${lead.value.toLocaleString()}
                </span>
              )}
            </div>
          </div>
          
          {lead.email && (
            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-slate-500'} mb-2`}>{lead.email}</p>
          )}

          {upcomingActivities.length > 0 && (
            <div className="flex items-center gap-1 text-xs text-orange-600 mb-2">
              <Bell className="w-3 h-3" />
              <span>{upcomingActivities.length} upcoming</span>
            </div>
          )}
        </div>
      </div>

      {showDetails && (
        <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-gray-600' : 'border-slate-200'} space-y-2`}>
          <div className="flex gap-1">
            <button
              onClick={onAddActivity}
              className="flex-1 bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700 transition-colors"
            >
              + Activity
            </button>
            <button
              onClick={() => onDuplicate(lead.id)}
              className={`p-1.5 rounded ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-slate-200 text-slate-700'} hover:opacity-80`}
              title="Duplicate"
            >
              <Copy className="w-4 h-4" />
            </button>
            <button
              onClick={() => onDelete(lead.id)}
              className="p-1.5 rounded bg-red-600 text-white hover:bg-red-700"
              title="Delete"
            >
              <Trash2 className="w-4 h-4" />
            </button>
          </div>
          
          <select
            value={lead.stage}
            onChange={(e) => onStageChange(lead.id, e.target.value)}
            className={`w-full px-2 py-1.5 text-xs border ${darkMode ? 'bg-gray-600 border-gray-500 text-gray-100' : 'border-slate-300'} rounded focus:ring-2 focus:ring-blue-500`}
          >
            {stages.map(stage => (
              <option key={stage.id} value={stage.id}>{stage.name}</option>
            ))}
          </select>

          {lead.activities && lead.activities.length > 0 && (
            <div className="space-y-1 max-h-32 overflow-y-auto">
              {lead.activities.slice(0, 3).map(activity => (
                <div key={activity.id} className="flex items-center gap-2 text-xs">
                  <input
                    type="checkbox"
                    checked={activity.completed}
                    onChange={() => onActivityComplete(lead.id, activity.id)}
                    className="rounded"
                  />
                  <span className={activity.completed ? `line-through ${darkMode ? 'text-gray-500' : 'text-slate-400'}` : darkMode ? 'text-gray-300' : 'text-slate-700'}>
                    {activity.type}: {activity.description}
                  </span>
                </div>
              ))}
            </div>
          )}

          {lead.leadSource && (
            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-slate-500'}`}>
              Source: {lead.leadSource}
            </p>
          )}
          {lead.industry && (
            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-slate-500'}`}>
              Industry: {lead.industry}
            </p>
          )}
        </div>
      )}
    </div>
  );
}

function ActivityRow({ activity, darkMode, onComplete }) {
  const Icon = ACTIVITY_TYPES.find(t => t.id === activity.type)?.icon || CheckSquare;
  const dueDate = new Date(activity.dueDate);
  const isOverdue = !activity.completed && dueDate < new Date();
  const isDueSoon = !activity.completed && dueDate <= new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);

  return (
    <div className={`p-4 hover:bg-opacity-50 transition-colors ${activity.completed ? 'opacity-60' : ''} ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-slate-50'}`}>
      <div className="flex items-start gap-4">
        <input
          type="checkbox"
          checked={activity.completed}
          onChange={onComplete}
          className="mt-1 rounded"
        />
        <Icon className={`w-5 h-5 mt-0.5 ${darkMode ? 'text-gray-500' : 'text-slate-400'}`} />
        <div className="flex-1">
          <div className="flex items-start justify-between">
            <div>
              <h4 className={`font-medium ${activity.completed ? `line-through ${darkMode ? 'text-gray-500' : 'text-slate-500'}` : darkMode ? 'text-gray-100' : 'text-slate-900'}`}>
                {activity.description}
              </h4>
              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-slate-600'} mt-1`}>
                {activity.leadName}
              </p>
            </div>
            <div className="text-right">
              <p className={`text-sm font-medium ${
                isOverdue ? 'text-red-600' :
                isDueSoon ? 'text-orange-600' :
                darkMode ? 'text-gray-400' : 'text-slate-600'
              }`}>
                {dueDate.toLocaleDateString()}
              </p>
              <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-slate-500'} mt-1 capitalize`}>
                {activity.type}
              </p>
            </div>
          </div>
          {activity.notes && (
            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-slate-500'} mt-2`}>{activity.notes}</p>
          )}
        </div>
      </div>
    </div>
  );
}

function AnalyticsCard({ title, value, icon: Icon, color, darkMode }) {
  return (
    <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-slate-200'} rounded-lg shadow-sm border p-6`}>
      <div className="flex items-center justify-between">
        <div>
          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-slate-600'} mb-1`}>{title}</p>
          <p className={`text-2xl font-bold ${darkMode ? 'text-gray-100' : 'text-slate-900'}`}>{value}</p>
        </div>
        <Icon className={`w-10 h-10 ${color} opacity-80`} />
      </div>
    </div>
  );
}

function AddLeadModal({ onClose, onAdd, darkMode }) {
  const [formData, setFormData] = useState({
    name: '',
    company: '',
    email: '',
    phone: '',
    value: '',
    notes: '',
    leadSource: '',
    industry: ''
  });

  const handleSubmit = () => {
    if (!formData.name.trim()) {
      alert('Please enter a contact name');
      return;
    }
    onAdd({
      ...formData,
      value: formData.value ? parseFloat(formData.value) : 0
    });
  };

  const bgClass = darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = darkMode ? 'text-gray-100' : 'text-slate-900';
  const inputClass = darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'border-slate-300';

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className={`${bgClass} rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`}>
        <div className="p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className={`text-2xl font-bold ${textClass}`}>Add New Lead</h2>
            <button onClick={onClose} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-slate-400 hover:text-slate-600'}>
              <X className="w-6 h-6" />
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Contact Name *
              </label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Company
              </label>
              <input
                type="text"
                value={formData.company}
                onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Email
              </label>
              <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Phone
              </label>
              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Deal Value ($)
              </label>
              <input
                type="number"
                value={formData.value}
                onChange={(e) => setFormData({ ...formData, value: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Lead Source
              </label>
              <select
                value={formData.leadSource}
                onChange={(e) => setFormData({ ...formData, leadSource: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              >
                <option value="">Select source...</option>
                {LEAD_SOURCES.map(source => (
                  <option key={source} value={source}>{source}</option>
                ))}
              </select>
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Industry
              </label>
              <select
                value={formData.industry}
                onChange={(e) => setFormData({ ...formData, industry: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              >
                <option value="">Select industry...</option>
                {INDUSTRIES.map(industry => (
                  <option key={industry} value={industry}>{industry}</option>
                ))}
              </select>
            </div>
            <div className="md:col-span-2">
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Notes
              </label>
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={3}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
          </div>
          <div className="flex gap-3 pt-4 mt-4 border-t border-opacity-20">
            <button
              onClick={onClose}
              className={`flex-1 px-4 py-2 border ${darkMode ? 'border-gray-600 text-gray-300' : 'border-slate-300 text-slate-700'} rounded-lg hover:bg-opacity-50 transition-colors`}
            >
              Cancel
            </button>
            <button
              onClick={handleSubmit}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Lead
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function AddActivityModal({ lead, onClose, onAdd, darkMode }) {
  const [formData, setFormData] = useState({
    type: 'call',
    description: '',
    dueDate: '',
    reminderDate: '',
    notes: ''
  });

  const handleSubmit = () => {
    if (!formData.description.trim() || !formData.dueDate) {
      alert('Please fill in description and due date');
      return;
    }
    onAdd(formData);
  };

  const bgClass = darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = darkMode ? 'text-gray-100' : 'text-slate-900';
  const inputClass = darkMode ? 'bg-gray-700 border-gray-600 text-gray-100' : 'border-slate-300';

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className={`${bgClass} rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto`}>
        <div className="p-6">
          <div className="flex items-center justify-between mb-2">
            <h2 className={`text-2xl font-bold ${textClass}`}>Add Activity</h2>
            <button onClick={onClose} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-slate-400 hover:text-slate-600'}>
              <X className="w-6 h-6" />
            </button>
          </div>
          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-slate-600'} mb-4`}>For: {lead.name}</p>
          <div className="space-y-4">
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Activity Type *
              </label>
              <select
                value={formData.type}
                onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              >
                {ACTIVITY_TYPES.map(type => (
                  <option key={type.id} value={type.id}>{type.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Description *
              </label>
              <input
                type="text"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="e.g., Follow up on proposal"
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Due Date *
              </label>
              <input
                type="date"
                value={formData.dueDate}
                onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Reminder Date
              </label>
              <input
                type="date"
                value={formData.reminderDate}
                onChange={(e) => setFormData({ ...formData, reminderDate: e.target.value })}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div>
              <label className={`block text-sm font-medium ${textClass} mb-1`}>
                Notes
              </label>
              <textarea
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                rows={3}
                className={`w-full px-3 py-2 border ${inputClass} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
              />
            </div>
            <div className="flex gap-3 pt-4">
              <button
                onClick={onClose}
                className={`flex-1 px-4 py-2 border ${darkMode ? 'border-gray-600 text-gray-300' : 'border-slate-300 text-slate-700'} rounded-lg hover:bg-opacity-50 transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={handleSubmit}
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                Add Activity
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function SettingsModal({ onClose, onExportCSV, onImportCSV, fileInputRef, darkMode, leads }) {
  const bgClass = darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = darkMode ? 'text-gray-100' : 'text-slate-900';

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className={`${bgClass} rounded-lg shadow-xl max-w-md w-full`}>
        <div className="p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className={`text-2xl font-bold ${textClass}`}>Settings</h2>
            <button onClick={onClose} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-slate-400 hover:text-slate-600'}>
              <X className="w-6 h-6" />
            </button>
          </div>
          <div className="space-y-4">
            <div>
              <h3 className={`font-semibold ${textClass} mb-2`}>Data Management</h3>
              <div className="space-y-2">
                <button
                  onClick={onExportCSV}
                  className="w-full flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Download className="w-4 h-4" />
                  Export to CSV
                </button>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                >
                  <Upload className="w-4 h-4" />
                  Import from CSV
                </button>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".csv"
                  onChange={onImportCSV}
                  className="hidden"
                />
              </div>
            </div>
            <div className={`p-4 ${darkMode ? 'bg-gray-700' : 'bg-slate-50'} rounded-lg`}>
              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-slate-700'}`}>
                Total Leads: <strong>{leads.length}</strong>
              </p>
              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-slate-700'} mt-1`}>
                Data is automatically saved to your browser
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
